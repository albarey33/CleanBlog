I"¦<h1 id="01-merging-excel-files-with-equal-structure-with-inheritr">01 Merging Excel files with equal structure with inherit.R</h1>
<p>Script to read excel files with the same structure: equal fields.</p>

<p>Use Case: To import data on parts and integrate them into one data file</p>

<p>Example: To build the monthly enrollment list data CSV file 
for data analysis of Care Management results.
Data Source: PATIENT HEALTH DASHBOARD (PHD) - POPULATION SUMMARY
FREQUENCY OF PROCESS: Execute this script after enrollment ONCE A MONTH</p>

<h3 id="0-prepare-install-call-packages-">0 PREPARE INSTALL CALL PACKAGES â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“</h3>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rm</span><span class="p">(</span><span class="n">list</span><span class="o">=</span><span class="n">ls</span><span class="p">())</span><span class="w"> </span><span class="c1"># Delete all objects</span><span class="w">
</span><span class="n">ls</span><span class="p">()</span><span class="w"> </span><span class="c1"># List variables in memory</span><span class="w">

</span><span class="n">options</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> 
        </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strOptions</span><span class="p">(</span><span class="n">strict.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cut"</span><span class="p">),</span><span class="w"> 
        </span><span class="n">readr.show_progress</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="n">st</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.time</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>
<h1 id="libpathscr_libraries------defined-as-environmental-variable">.libPaths(â€œC:/R_Librariesâ€)     # Defined as Environmental Variable</h1>
<h1 id="libpaths---check-the-default-folder-where-packages-are-installed">.libPaths() ###  Check the default folder where packages are installed</h1>

<h1 id="load-multiple-packages-at-once">Load-multiple-packages-at-once</h1>
<p>required_packages &lt;- c(â€œdplyrâ€, â€œreadxlâ€, â€œdata.tableâ€)
lapply(required_packages, library, character.only = TRUE)</p>

<h1 id="1-parameters-change-names--update-">1 PARAMETERS CHANGE NAMES / UPDATE â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“</h1>

<p>currPPL &lt;- â€œ202106â€     # Update</p>

<h1 id="paths">Paths</h1>
<h1 id="location-of-source-files">Location of Source files</h1>
<p>path            &lt;- â€œPopulationSamplesâ€     <br />
#path &lt;- â€œPopulationSamples//DATA_Interactions_by_CM//â€ # if sub-folder</p>

<h1 id="location-of-resulting-file--">Location of resulting file â€”-</h1>
<p>resultingfile   &lt;- paste0(â€œPopulationSamples//MergedFileâ€, currPPL, â€œ.csvâ€)</p>

<h1 id="2-read-the-downloaded-data-excel-files-">2 READ THE DOWNLOADED DATA EXCEL FILES â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</h1>
<h1 id="read-sample-files-using-full-path-and-regex-known-pattern">Read sample files using full path and regex (known pattern)</h1>

<p>filenames_list &lt;- list.files(path= path, full.names=TRUE, 
                 pattern=paste0(â€œ^Patient.*?â€,currPPL,â€_1000pts.xlsxâ€))
filenames_list</p>

<h1 id="-22-function-read-excel-files-with-equal-structure-">* 2.2 Function: Read Excel files with equal structure â€”â€”â€“</h1>

<p>fx_readfiles &lt;- function(filename){
  print(paste(â€œMergingâ€,filename,sep = â€œ â€œ))
  xlfile &lt;- readxl::read_excel(filename)#, col_types = vectortypes)
  print(paste(â€œNumber of records in â€œ,
              filename,â€ = â€œ,nrow(xlfile),
              â€œ ; columns = â€œ,length(xlfile),sep=â€â€))
  xlfile[] &lt;- lapply(xlfile, function(x) {        # Change field types
    if (inherits(x, â€œlogicalâ€)) as.character(x) else x
  })
  dfXLfile &lt;- data.frame(xlfile)
  dfXLfile
  }</p>

<h1 id="apply-defined-function-to-list">Apply defined function to list</h1>
<p>tibbles &lt;- lapply(filenames_list,fx_readfiles)
tibbles
str(tibbles[1])</p>

<p>#merged &lt;- do.call(rbind, tibbles) # Alternative
PPL_df &lt;- data.frame(do.call(dplyr::bind_rows, tibbles))</p>

<p>head(PPL_df,1)
dim(PPL_df)
str(PPL_df)</p>

<h1 id="3-change-df-field-names-without-numbers-using-pattern--regex-">3 CHANGE DF FIELD NAMES WITHOUT NUMBERS USING pattern + REGEX â€”â€”â€”â€”â€”</h1>
<h1 id="prefixed-with-x-field-names-automatically-when-merged">PREFIXED WITH X FIELD NAMES AUTOMATICALLY WHEN MERGED</h1>
<p>names(PPL_df) &lt;- sub(â€œX[0-9]{1,2}..â€,â€â€œ,names(PPL_df))  # Regular expressions</p>

<h1 id="4-add-column-current-month-">4 Add column current month â€”â€”â€”â€”â€”</h1>
<p>PPL_df$PPL &lt;- currPPL<br />
str(PPL_df)</p>

<h1 id="5-write-resulting-data-table--">5 WRITE RESULTING DATA TABLE â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</h1>

<p>str(PPL_df)
dim(PPL_df)</p>

<p>data.table::fwrite(PPL_df,resultingfile)</p>

<p>Sys.time() - st</p>

<h1 id="notes">NOTES:</h1>
<p>#CM_List &lt;- read_excel(â€œt_VH_Assigned_CM_in_Care_Team.xlsmâ€,</p>
<h1 id="sheetcc4c_ob_cms-rangek7k60">sheet=â€™CC4C_OB_CMsâ€™, range=â€K7:K60â€)</h1>

<p>############## END â€”â€”</p>
:ET